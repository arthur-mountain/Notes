# Git Describe

用於生成當前提交（commit）的可讀性描述。通過尋找最近的標籤（tag），
計算從該標籤到當前提交之間的距離，生成一個形如 `標籤-提交數-提交哈希值` 的字符串。

## 什麼是 `git describe`？

當想快速瞭解當前提交在項目歷史中的位置時，`git describe` 會非常有用。它能夠：

- **生成自動版本號**：在軟體開發中，自動生成的版本號可以反映項目的發展狀態。

- **標記當前提交位置**：有助於在團隊協作中快速共享和定位工作進度。

---

## 輸出格式

通常，`git describe` 的輸出格式為：

```plaintext
<最近的標籤>-<提交數>-g<提交哈希值>
```

**例子**：

```bash
v1.0.0-3-gd5f7c32
```

這表示：

- **最近的標籤**：`v1.0.0`

- **提交數**：從該標籤以來有 3 次提交

- **提交哈希值**：當前提交的哈希值（前 7 位）為 `d5f7c32`

---

## 常用範例

### 範例一：自動生成版本號

**情境**：正在開發一個軟體項目，需要根據 Git 的提交情況自動生成一個可用的版本號。

**指令**：

```bash
git describe
```

**說明**：

假設已經在某個穩定版本上打了標籤，比如 `v1.0.0`，然後繼續進行了一些提交。
在沒有打新標籤之前，使用 `git describe` 可以自動生成類似 `v1.0.0-3-gd5f7c32` 的版本號。

---

### 範例二：快速定位當前工作進度

**情境**：如果正在進行開發，但不確定當前分支相對於上一個發布版本的位置，`git describe` 可以幫助快速瞭解進度。

**指令**：

```bash
git describe --tags
```

**說明**：

這個指令會列出基於最近標籤的描述，包括所有標籤（輕量級和註釋標籤），方便與團隊成員溝通當前的工作進度。

---

### 範例三：取得最近的標籤名稱

**情境**：想知道當前分支最近的標籤是什麼，而不需要額外的提交數或哈希值資訊。

**指令**：

```bash
git describe --abbrev=0
```

**說明**：

- `--abbrev=0`：將提交哈希值的縮寫長度設為 0，只顯示標籤名稱。

- **結果**：只會輸出最近的標籤，例如 `v1.0.0`。

---

### 範例四：顯示未提交變更的狀態

**情境**：想知道當前工作目錄是否有未提交的變更，並希望在描述中顯示這個資訊。

**指令**：

```bash
git describe --dirty
```

**說明**：

- `--dirty`：如果工作目錄有未提交的變更，輸出結果會在最後加上 `-dirty`。

- **結果**：例如 `v1.0.0-3-gd5f7c32-dirty`，表示有未提交的變更。

---

### 範例五：包含所有引用（標籤、分支等）

**情境**：希望 `git describe` 不僅考慮標籤，還包含所有的引用（如分支名）來描述當前提交。

**指令**：

```bash
git describe --all
```

**說明**：

- `--all`：使用所有的參考（標籤、分支、HEAD 等）進行描述。

- **結果**：輸出可能類似於 `heads/feature-branch-2-gd5f7c32`。

---

### 範例六：自定義提交哈希值的長度

**情境**：希望調整輸出中提交哈希值的長度，以符合的需求。

**指令**：

```bash
git describe --abbrev=4
```

**說明**：

- `--abbrev=4`：將哈希值縮寫為 4 個字元。

- **結果**：例如 `v1.0.0-3-gd5f7`。

---

### 範例七：僅使用註釋標籤

**情境**：只想基於註釋標籤，而忽略輕量級標籤來描述當前提交。

**指令**：

```bash
git describe --tags --match "v[0-9]*"
```

**說明**：

- `--tags`：包含所有標籤。

- `--match "v[0-9]*"`：只匹配符合指定模式的標籤，例如以 `v` 開頭的版本號。

- **結果**：過濾後只會考慮符合條件的註釋標籤。

---

### 範例八：在腳本中使用 `git describe` 進行版本控制

**情境**：在自動化腳本或持續整合系統中，需要取得當前版本資訊作為變數。

**指令**：

```bash
VERSION=$(git describe --tags --dirty)
echo "當前版本：$VERSION"
```

**說明**：

- 將 `git describe` 的輸出結果存入變數 `VERSION`。

- 可以在腳本中使用該變數進行版本控制、打包等操作。

- **結果**：例如輸出 `當前版本：v1.0.0-3-gd5f7c32`。

---

### 範例九：追溯特定提交的版本資訊

**情境**：想知道某個特定提交（非當前提交）的版本描述。

**指令**：

```bash
git describe <commit-hash>
```

**說明**：

- `<commit-hash>`：指定想要描述的提交哈希值。

- **結果**：輸出該提交的版本描述，例如 `v0.9.0-10-g3a1b2c4`。

---

### 範例十：使用 `git describe` 生成可預測的版本號

**情境**：希望生成一個不包含提交哈希值的可預測版本號，例如在發布前使用。

**指令**：

```bash
git describe --long --tags --match "v[0-9]*" --first-parent
```

**說明**：

- `--long`：總是輸出完整格式的描述。

- `--first-parent`：僅跟隨第一父提交，忽略分支合併歷史。

- **結果**：生成一個更可預測的版本號，例如 `v1.0.0-3-0`。

---

## 詳細參數和用法

### 基本用法

```bash
git describe [<options>] [<commit>]
```

- `<commit>`：可選，指定想要描述的提交（默認為 `HEAD`）。

---

### 常用參數

#### `--tags`

**說明**：允許使用輕量級標籤和註釋標籤。

**用法**：

```bash
git describe --tags
```

**示例**：

如果項目中有輕量級標籤，默認情況下 `git describe` 可能不會考慮它們。使用 `--tags` 可以包含所有標籤。

---

#### `--all`

**說明**：使用所有引用（標籤、分支、遠端分支等）進行描述，而不僅僅是標籤。

**用法**：

```bash
git describe --all
```

**示例**：

```bash
git describe --all
# 輸出可能是：heads/feature-branch-2-gd5f7c32
```

---

#### `--abbrev=<n>`

**說明**：指定哈希值縮寫的長度（默認為 7）。

**用法**：

```bash
git describe --abbrev=4
```

**示例**：

```bash
git describe --abbrev=4
# 輸出：v1.0.0-3-gd5f7
```

---

#### `--candidates=<n>`

**說明**：指定在多遠的歷史中搜索可用的標籤，數值越大搜索越深（默認為 10）。

**用法**：

```bash
git describe --candidates=0
```

**示例**：

`--candidates=0` 會禁止 `git describe` 使用任何標籤，如果沒有完全匹配的標籤，命令將失敗。

---

#### `--exact-match`

**說明**：僅當提交正好對應於一個標籤時才輸出標籤名稱，否則命令失敗。

**用法**：

```bash
git describe --exact-match
```

**示例**：

如果當前提交沒有與標籤精確匹配，將會輸出錯誤。

---

#### `--dirty` 和 `--broken`

**說明**：

- `--dirty`：如果工作目錄有未提交的變更，輸出結果會在最後加上 `-dirty`。

- `--broken`：如果儲存庫損壞，輸出結果會在最後加上 `-broken`。

**用法**：

```bash
git describe --dirty
```

**示例**：

```bash
git describe --dirty
# 輸出：v1.0.0-3-gd5f7c32-dirty
```

---

#### `--long`

**說明**：總是輸出完整格式，即使當前提交正好對應一個標籤。

**用法**：

```bash
git describe --long
```

**示例**：

```bash
git describe --long
# 如果在標籤上，輸出：v1.0.0-0-gd5f7c32
```

---

#### `--match <pattern>`

**說明**：只考慮匹配指定模式的標籤。

**用法**：

```bash
git describe --match "v[0-9]*"
```

**示例**：

只考慮以 `v` 開頭的標籤，如 `v1.0`, `v2.1.3`。

---

#### `--exclude <pattern>`

**說明**：排除匹配指定模式的標籤。

**用法**：

```bash
git describe --exclude "beta*"
```

**示例**：

排除所有以 `beta` 開頭的標籤，如 `beta1.0`, `beta2.0`。

---

#### `--first-parent`

**說明**：沿著第一父提交（通常是主分支）進行追溯，忽略分支合併歷史。

**用法**：

```bash
git describe --first-parent
```

**示例**：

在大型項目中，這有助於避免因分支導致的複雜歷史，提供更線性的描述。

---

### 進階用法

#### 自定義描述格式

可以使用 `git describe` 來生成自定義的版本號或描述。

**示例**：生成類似於 `1.0.0+build.3.gd5f7c32` 的版本號。

**步驟**：

1. 使用 `--match` 過濾標籤。

2. 使用 `--long` 強制輸出完整格式。

3. 使用 `sed` 或其他工具修改輸出格式。

```bash
git describe --match "v[0-9]*" --long | sed 's/^v//;s/-/+/;s/-/./'
# 輸出：1.0.0+build.3.gd5f7c32
```

---

#### 在腳本中檢查是否在標籤上

**用法**：

```bash
if git describe --exact-match > /dev/null 2>&1
then
  echo "當前提交有標籤"
else
  echo "當前提交沒有標籤"
fi
```

**說明**：利用 `--exact-match` 判斷當前提交是否有標籤。

---

#### 獲取最近標籤之間的提交列表

**用法**：

```bash
git log $(git describe --abbrev=0)..HEAD
```

**說明**：列出自最近標籤以來的所有提交。

---

#### 使用 `--debug` 參數

**說明**：顯示搜索過程的調試資訊，有助於瞭解 `git describe` 如何選擇標籤。

**用法**：

```bash
git describe --debug
```

**示例**：

會輸出詳細的搜索過程，包括每個候選標籤與當前提交的距離。

---

#### 忽略特定的提交物件類型

**說明**：使用 `--exclude` 來排除特定的標籤或引用。

**用法**：

```bash
git describe --exclude "refs/remotes/*"
```

**示例**：

排除所有遠端分支的引用，只考慮本地的標籤和分支。

---

## 總結

- **`git describe` 的靈活性**：透過不同的參數組合，可以滿足各種版本控制和資訊查詢的需求。

- **實用性**：在自動化腳本、版本管理、協作開發等多種情境下，都能發揮重要作用。

- **最佳實踐**：結合標籤命名規則和適當的參數，提升版本管理的效率。

---

## 資料來源

[git describe](https://git-scm.com/docs/git-describe)
