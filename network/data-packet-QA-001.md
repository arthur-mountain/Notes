# 封包 (data packet) QA - 001

Before we start, please make sure you have read the
[data packet overview](./data-packet.md) article.

1. 路由器會透過 ARP，使用目標 IP 地址向內網詢問 MAC 地址，把 ip mapping 到 MAC 地址?

   得到 MAC 地址後，再接著把封包丟到特定 MAC 地址？

   P.S. MAC 地址才是實際上的裝置，可能是電腦、手機

2. 為什麼路由器不把封包丟給內網，在透過內網丟給 MAC 地址？

   為什麼路由器需要知道MAC地址，而不是直接將封包丟給內網，再由內網「自行處理」?

## 一、IP 與 MAC 的關係

1. **IP地址(邏輯位址)**

   - 用於網路層(Layer 3)標識裝置在網路中的位置(例如 `192.168.x.x`、`10.x.x.x`)。

   - 主要用於路由與網路分段(Subnet)。

2. **MAC地址(實體位址)**

   - 資料鏈路層(Layer 2)上，每個網卡(乙太網卡或 Wi-Fi 網卡)獨一無二的硬體位址。

   - 在區域網路(LAN)中傳遞封包時最終依賴 MAC 進行「二層」識別和轉發。

3. **ARP(Address Resolution Protocol)**

   - 負責在同一個區域網路內，將 IP 和 MAC 地址相互映射起來。

   - 透過 ARP 請求(Broadcast)詢問「誰持有某 IP 地址」，

     該設備若存在，回覆自己的 MAC 地址。

---

## 二、路由器在內網如何發送封包

1. **先確認目標 IP 是否屬於內網**

   - 路由器若發現封包的目標 IP(如 `192.168.1.10`)在內網，就需要把封包導向區域網路。

2. **ARP 查詢過程**

   - 路由器廣播 ARP 請求：「誰是 192.168.1.10？請回覆 MAC 地址。」

   - 持有該 IP 的設備回應自己的 MAC 地址(例如 `AA:BB:CC:DD:EE:FF`)。

3. **更新路由器的 ARP Cache**

   - 路由器取得該 IP 的 MAC 後，會記錄在 ARP Cache 表格中，避免重複查詢。

4. **填入封包頭並送進內網**

   - 路由器在封包的二層頭部填入目標 MAC 地址，然後將封包送給交換機。

   - 交換機根據 MAC 地址表(MAC Table)把封包精準轉發到對應埠口上的設備。

---

## 三、為什麼需要這樣的流程？(避免「網路風暴」與確保正確傳遞)

1. **二層通訊依賴 MAC**

   - 在區域網路(LAN)中，交換機根據二層 MAC 目的地址做封包轉發，不是依照 IP。

   - 如果封包缺乏目標 MAC 地址，交換機無法判斷要往哪個埠口送，可能廣播給整個網路。

2. **避免網路風暴**

   - 若路由器不先拿到對應的 MAC 就直接「廣播丟封包」，

     會使交換機把封包傳給所有設備，造成網路壅塞或「廣播風暴」。

   - 確定目標 MAC 後再精準傳送，可保持網路穩定和高效率。

3. **交換機的角色**

   - 交換機透過 MAC 地址表將封包只送到目標設備的埠口，其他設備不受影響。

   - 這樣避免大量不必要的資料傳輸，也提高整個 LAN 的運作效率。

---

## 四、整個封包傳遞流程範例

1. **外部封包抵達路由器**

   - 路由器發現目標 IP (如 `192.168.1.10`) 屬於內網。

2. **ARP 解析**

   - 路由器查詢「192.168.1.10」的 MAC 地址。
     若需廣播 ARP，則以「誰持有此 IP？」詢問整個內網。

   - 持有該 IP 的設備回應其 MAC(`AA:BB:CC:DD:EE:FF`)。

3. **封包更新頭部並送入內網**

   - 路由器在 Ethernet 頭部寫入 `AA:BB:CC:DD:EE:FF`，把封包傳給交換機。

   - 交換機根據 MAC 表轉發到目標設備所接的埠口。

4. **目標設備接收處理**

   - 目標設備最終接收封包，進入作業系統的 TCP/IP 協定棧做後續處理。

---

## 五、目標 IP 不存在時的處理方式

1. **丟棄封包**

   - 當路由器嘗試查詢某個 IP 的 MAC 地址，內網回覆「該 IP 不存在」或無回應，

     路由器無法取得目標 MAC，便會直接丟棄該封包。

2. **回應 ICMP「目標不可達」訊息**

   - 若封包來源自外網，路由器可能回傳一個
     「Destination Unreachable」(ICMP 錯誤訊息)給來源端，
     以告知無法抵達目標。

3. **查詢或更新 ARP Cache**

   - 路由器若在 ARP Cache 裏已標註此 IP「不存在」，
     就不會再持續進行無效的 ARP 廣播，避免浪費資源。

4. **DHCP 與 IP 釋放情況**

   - 有些情況下，該 IP 可能是動態分配的 (DHCP)，但目前無設備使用或已釋放租約。
     這是正常現象，路由器一樣會丟棄封包並結束流程。

---

## 六、總結

- **先有 IP 地址，再透過 ARP 取得 MAC**:

  路由器在傳送內網封包時，必須透過 ARP 取得目標裝置的 MAC 才能在二層正確定位設備。

- **精準轉發、避免廣播風暴**:

  若不先解析 MAC，就丟封包進內網，會造成無意義的廣播和網路擾動。

- **目標 IP 不存在時**:

  路由器丟棄封包，並可回送 ICMP 錯誤給來源端；對內網則無須再廣播或浪費資源。

- **確保網路穩定性**:

  透過 ARP 機制、交換機的 MAC 表，以及丟棄無效封包等手段，維持內網高效率與穩定。
