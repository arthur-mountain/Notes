# DHCP 和 NAT 的協作原理

## 1. DHCP Server 如何分配私有 IP

- **DHCP 伺服器的角色**:

  當一台設備(例如電腦或手機)連接到內網時，設備會向 DHCP 伺服器請求 IP 位址，
  DHCP 伺服器會動態分配一個私有 IP 位址(例如 `192.168.1.10`)，並記錄這個分配。

- **DHCP 租約表**:

  DHCP 伺服器會保留一張「租約表」(Lease Table)，記錄內網設備的 MAC 位址和分配給它們的私有 IP 位址。
  即`內網 MAC 位址`和`私有 IP 位址`的映射表。
  這樣，DHCP 伺服器知道網路中每台設備的內部 IP 分配情況。

## 2. NAT 如何知道將數據轉發給哪個私有 IP

NAT 並不需要向 DHCP 伺服器查詢私有 IP 位址，因為 NAT 只處理已經分配的 IP 流量。

NAT 通過 **連接追踪表** 來管理內外網的連接，具體過程如下：

- **連接追踪表(NAT Translation Table)**:

  當內網中的設備向外發送請求(例如訪問網站)時，NAT 會記錄下這個連接， 並將私有 IP 位址和對應的公有 IP 及埠號映射到一張表中。
  即`私有 IP 位址 + 其內網設備得埠號`和`公有 IP 位址 + 其公有設備得埠號`的映射表。

- **連接請求進出流程**:

  1. 當內網設備(例如 `192.168.1.10`)向外部發送請求時，
     NAT 會將這個私有 IP 映射到公有 IP(例如 `203.0.113.1`)，並為連接分配一個埠號(例如 `203.0.113.1:50000`)。

  2. NAT 會將這個映射記錄在連接追踪表中，以便後續回應時能將數據轉發給正確的私有 IP 設備。

  3. 當回應數據包返回到路由器時，NAT 查詢追踪表，找到對應的私有 IP 位址(例如 `192.168.1.10`)，並將數據轉發給該設備。

## 3. NAT 與 DHCP 的協作

NAT 和 DHCP 並不直接通信，而是各自完成自己的任務，並通過以下方式協作：

- **DHCP 分配私有 IP**: DHCP 為內網設備分配動態 IP 位址，並持有私有 IP 的分配資訊。

- **NAT 管理連接追踪表**: NAT 通過連接追踪表，記錄內外網之間的連接映射，並根據連接表將外部回應正確地轉發到私有 IP 位址。

## 4. 連接中斷後的處理

如果內網中的設備重新獲得了新的私有 IP 位址(例如: DHCP 租約到期後變更)，

連接追踪表中的舊映射將失效，NAT 會重新記錄新的連接請求並更新映射。

## 5. 整體協作流程

1. **設備請求私有 IP**：

   - 你的設備(例如電腦或手機)連接到內網時，會向 DHCP 伺服器發送 IP 位址請求。

   - DHCP 伺服器為設備分配一個 **私有 IP 位址**，並記錄設備的 **MAC 位址和私有 IP 的映射** 在租約表(Lease Table)中。

2. **設備發送外部請求**：

   - 當你訪問網際網路(例如: 查詢網站)時，設備會將請求封包發送到路由器上的 NAT，

     這個封包的來源是你的私有 IP(例如 `192.168.1.10`)和相應的內網埠。

3. **NAT 建立映射並分配外部埠**：

   - NAT 接收到你的請求後，會為私有 IP 位址和埠分配一個 **公有 IP 位址和外部埠**(例如 `203.0.113.1:50000`)。

   - 同時，NAT 將這個映射記錄在 **連接追踪表**(Translation Table)中，記錄私有 IP + 埠和公有 IP + 埠的對應關係。

4. **NAT 轉發封包至目的地**：

   - NAT 將封包的來源位址從私有 IP(如 `192.168.1.10`)替換為分配的公有 IP + 埠(如 `203.0.113.1:50000`)，

     並將請求發送到你要訪問的目標公有 IP 位址(如: 網站伺服器的 IP)。

5. **數據回應並匹配映射**：

   - 當目標伺服器回應數據時，數據包會回到你的 NAT 設備，

     NAT 會檢查回應封包的目標 IP 和埠(如：`203.0.113.1:50000`，即第四步時所分配的公有 IP + 埠)。

   - NAT 根據連接追踪表，查找這個外部埠對應的私有 IP，發現該封包對應到 `192.168.1.10`。

6. **NAT 將數據回傳到私有 IP 設備**：

   - NAT 將封包的目標位址從公有 IP + 埠(`203.0.113.1:50000`)替換回私有 IP(`192.168.1.10`)，並將數據包轉發到該設備。

   - 你的設備最終接收到該數據包，完成了整個通信流程。

### 總結

- **DHCP 伺服器負責分配私有 IP 位址**，但不會與 NAT 直接交互。

- **DHCP** 分配私有 IP 位址，並記錄設備的 MAC 位址與 IP 的映射。

- **NAT** 根據外部請求，分配公有 IP + 埠，並在連接追踪表中記錄映射關係。

- **NAT** 收到網際網路回來的數據回應時，NAT 查連接追踪表找到對應的私有 IP，替換到封包內的目標 IP 和埠後，再進一步將數據回傳給內網設備。

- **NAT 和 DHCP 的協作** 是通過各自的記錄(連接追踪表和租約表)來完成的，而不是直接查詢對方的資訊。
