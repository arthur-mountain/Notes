# 封包 (data packet)

Before we start, please make sure you have read the

1. [public ip and private ip](../public-and-private-ip.md)

2. [DHCP and NAT](../dhcp-and-nat.md)

## Summary

IP 數據包(封包)，如何從外部網路(外網)通過路由器轉發封包，到內部網路(內網)的目標設備上。

## 1. 外網 vs. 內網

- **外網(Internet)**: 同**公有IP (Public IP)**

  指的是全球的公開網際網路，即我們日常瀏覽的網站、網頁和外部服務所處的網路。

  這些網路對所有人公開，並通過唯一的公有IP地址來進行識別。

- **內網(Intranet/LAN，Local Area Network)**: 同**私有IP (Private IP)**

  指的是在企業、家庭或其他本地環境中使用的私有網路。

  例如，公司或家裡的Wi-Fi網路就是一個內網。

  內網中的設備(如電腦、手機、伺服器等)通常使用私有IP地址，這些地址只能在內網中互相訪問，而無法直接從外部訪問。

  當我們的數據封包從外部網際網路傳送到內部網路中的目標設備時，需要通過路由器來進行轉發和處理。

  路由器通常會將公有IP地址映射到內網的私有IP地址。

## 2. MAC地址(硬體地址)

- **MAC地址**(Media Access Control Address) 是網路設備的物理地址，
  它是每一個網路卡(乙太網卡或Wi-Fi網卡)的唯一標識，格式通常是六組十六進制數字(如`00:1A:2B:3C:4D:5E`)。

- MAC地址在OSI第二層(數據鏈路層)使用，是設備在內網中辨識的依據，因此在同一內網中的所有設備都有唯一的MAC地址。

- 封包在傳送時，會使用目標設備的MAC地址來確定目標設備。

## 3. ARP(地址解析協議)

- **ARP(Address Resolution Protocol)**:

  是一種協定，用來將**IP地址解析成MAC地址**。

  當一台設備知道目標設備的IP地址但不知道其MAC地址時，會**使用ARP來查找目標設備的MAC地址**，從而實現正確的數據傳遞。

- ARP只在局域網中使用，因為MAC地址在網路之間(外網)並不公開或傳遞。只有當數據到達局域網時，才需要使用ARP來查詢目標MAC地址。

## 4. 網路介面

- **網路介面**是設備的網路接口，例如乙太網卡、Wi-Fi網卡或虛擬網卡等。每個網路介面都會綁定一個MAC地址和一個IP地址。

- 網路介面可以看成是設備和網路之間的門戶，所有進出數據都要通過網路介面進行。

## 5. 數據封包的傳送過程與ARP解析

---

接下來，詳細解釋封包如何從外部傳送到內部網路的目標設備，並如何使用ARP解析MAC地址。

### 步驟 1：數據封包進入內網

當一個封包，從外網經過路由器時，路由器會有路由表，去映射該IP地址是內網的哪一台設備。

此時路由器具有了具體目標的**私有IP地址**(比如`192.168.1.10`)，這是內網中目標設備的IP地址。

### 步驟 2：ARP 解析 MAC 地址

- 路由器知道目標設備的IP地址，但它需要確定這個IP地址對應的MAC地址，才能將封包傳送到正確的設備。

- 路由器會發送一個ARP請求，這是一個廣播封包，向內網中的所有設備詢問：「誰的IP地址是192.168.1.10？請告訴我你的MAC地址！」

- 內網中具有該IP地址的設備(如`192.168.1.10`的設備)會收到這個ARP請求，
  並回應說：「我的MAC地址是`AA:BB:CC:DD:EE:FF`。」這樣，路由器就知道該IP地址對應的MAC地址了。

### 步驟 3：將數據封包傳送給目標設備

- 路由器將**目標MAC地址填入數據封包的二層(鏈路層)頭部**，並通過內網將這個封包發送給該MAC地址所對應的網路介面(即目標設備的網卡)。

  - 在每個階段，封包都會被解析，並在重新封裝。

  例如，這邊路由器把查詢到得目標MAC地址填入第二層頭部(什麼是第二層頭部，後續會再詳細介紹)後再重新封裝並往內網中得設備發送。

  - 因此，每個階段當設備接收到封包時，封包都會解析，並提取所需的信息，例如這邊得MAC地址，然後再重新封裝並往下一層發送。

- 封包到達正確的網卡後，該設備的網路介面會接收數據並將其傳遞給作業系統。

### 步驟 4：作業系統的網路堆疊檢查封包

- 數據進入目標設備的作業系統後，作業系統會檢查封包的IP地址，確認這個封包的目標IP是本機的IP地址。

- 一旦確認無誤，封包便會傳送到應用程式進行進一步處理(例如HTTP請求由網頁伺服器處理)。

## 總結

1. **外網數據包進入局域網**:

   外部數據封包經過路由器進入局域網，並攜帶內網目標IP地址。

2. **ARP 解析**:

   路由器解封封包通過ARP查詢目標IP的MAC地址，將封包重新封裝並發送給正確的網路介面。

3. **封包傳送至目標設備**:

   路由器使用目標設備的MAC地址，將封包傳送到該設備的網路介面。

4. **作業系統處理封包**:

   封包進入設備的作業系統後，網路堆疊檢查目標IP，將數據傳送給對應應用程式處理。
   ARP 解析在此過程中扮演了橋樑作用，使封包能夠通過MAC地址找到目標設備的網路介面。
