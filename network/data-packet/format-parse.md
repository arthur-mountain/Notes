# 封包解析(data packet parse)

在開始之前，請確保您已閱讀以下內容：

1. [data packet format](./format.md)

## Summary

各層協議通常依賴**固定的結構格式**和**header 長度字段**來精確定位 header 的範圍，

這樣接收方就可以準確地解析每層數據，而不會誤讀到下一層的數據。

## OSI 透過 header 來分割每層的資訊

1. **固定長度的 header**

   - 在許多協議中，header 的長度是固定的。例如：

     IPv4 header 的基本長度是 20 個位元組(20 bytes)，
     TCP header 的基本長度是 20 個位元組。

     這樣接收方可以直接根據固定長度讀取 header，知道結尾的位置。

   - 這種設計非常常見，因為它簡化了解析流程，減少了靈活性需求。

2. **header 長度字段**

   - 有些協議的 header 包含一個「header 長度」字段，表示該層的 header 總長度。

   接收方可以根據這個字段知道 header 的結束位置。例如：

   IPv4 的 header 中有一個「header 長度」字段，告訴接收方該 IP header 的長度。

   TCP 也有一個「header 長度」字段，告知 TCP header 的長度(因為 TCP header 的選項字段可能使其長度變動)。

3. **字段指示數據起點**

   - 有些協議使用特定字段指示數據的起始位置。這些字段通常放在 header 中，表明從哪個位元組開始才是該層的數據。例如：

   IPv6 header 中的「有效載荷長度(Payload Length)」字段，
   直接告訴接收方該數據的長度。

   這樣接收方可以精確地知道 IPv6 header 之後的數據範圍。

4. **協議規範**

   每層協議的標準規範都會詳細定義 header 各字段的長度和排列順序。

   例如：

   在 TCP 協議中， 源端口、目標端口、序列號等字段
   都有固定的位元組長度和順序。

   根據協議標準，接收方可以依據這些字段的長度解析 header，
   而不會讀到不屬於該層的數據。

### 範例: 解析 TCP header

假設接收方收到一個 TCP 段(Segment)，它可以通過以下步驟來解析 TCP header，並避免讀取到下一層數據：

1. **源端口和目標端口**(各 2 個位元組)：

   - 接收方從第一個位元組開始讀取，先讀取 2 個位元組的源端口，然後再讀取 2 個位元組的目標端口。

2. **序列號和確認號**(各 4 個位元組)：

   - 接著讀取 4 個位元組的序列號，再讀取 4 個位元組的確認號。

3. **header 長度字段**：

   - TCP header 中的「數據偏移量(Data Offset)」字段指示了 TCP header 的長度，單位是 4 位元組。接收方可以根據這個字段確定 header 的結尾位置。

4. **根據 header 長度字段確定數據起點**：

   - 接收方可以通過計算「數據偏移量」來確定 TCP header 結束的位置，從而開始讀取 TCP 數據部分。

## OSI 模型中的封裝和解封裝流程

1. **逐層封裝**

   - 當應用層(第七層)生成數據(如 HTTP 請求)，會先生成一段應用層數據(稱為「數據」)。

   - 傳輸層(第四層，如 TCP 或 UDP)會接收應用層的數據，並在其前面加上一段傳輸層的頭部(header)，這段數據稱為「段(Segment)」。

   - 然後，網路層(第三層，如 IP)會在 TCP 或 UDP 段前添加網路層頭部(IP 地址等)，形成「包(Packet)」。

   - 最後，數據鏈路層(第二層，如 Ethernet 以太網)會加上數據鏈路層的頭部(MAC 地址等)以及尾部(校驗和)，形成「幀(Frame)」。

   - 當幀進入物理層(第一層)時，數據被轉換為比特流，準備通過物理介質進行傳輸。

2. **頭部標記作用**

   - 各層的頭部中包含必要的信息，如源地址、目標地址、數據長度、協議類型等，這些數據會根據各層協議的格式被解析，因此不需要顯式的分隔符來區分每層的數據。

   - 每層的協議格式在設計時已經指定了頭部的結構和長度，接收方能夠依據協議格式來逐層解析數據。

3. **接收端的解封裝過程**

   - 當接收方的物理層接收到比特流後，會先將其還原為數據幀(第二層數據結構)。

   - 接著數據鏈路層會根據頭部信息判斷這是以太網幀，並解析 MAC 地址等信息，然後去掉數據鏈路層頭部並向上層傳遞。

   - 網路層解析 IP 包，去掉 IP 頭部，並根據頭部的「協議類型」字段判斷是否是 TCP 或 UDP 協議，並將數據包向傳輸層傳遞。

   - 傳輸層(如 TCP)會解析出端口號等信息，去掉傳輸層的頭部後，將數據遞交給應用層。

   - 最終，應用層接收到純粹的數據內容，完成整個解封裝過程。

### 總結

- OSI 模型各層協議主要通過**固定長度**和**header 長度字段**來確定 header 的結尾。

- 協議標準詳細定義了每個字段的長度和順序，使接收方能夠準確地解析 header，而不會誤讀到下一層數據。

- 各層協議設計時就包含了這些機制，以便接收方可以準確定位每層數據，完成解封裝過程。
