# IPv6中的**IPsec**(Internet Protocol Security，網際網路協定安全)

Before we start, please make sure you have read the

1. [IPv4 and IPv6](./ipv4-and-ipv6.md)

2. [IPv6 Security](./ipv6-security.md)

## Summary

IPsec 是一套用來在網路層提供**加密、安全驗證和數據完整性**的協定套件。

IPsec其實存在於IPv4和IPv6中，但在IPv6中，它被內建並且標準化為協定的一部分。以下是IPsec的詳細介紹:

## 1. IPsec的作用

IPsec的主要目的是**保護網路層的數據傳輸安全**，通過加密和驗證機制，確保數據在傳輸過程中不被篡改、竊聽或偽裝。

IPsec的安全功能包括:

- **數據加密**:

  保護數據內容的隱私性，防止未經授權的訪問。

- **數據完整性**:

  通過驗證確保數據未被篡改，接收方可以檢測到任何不符合驗證的數據。

- **數據來源驗證**:

  確保數據的發送方身份真實，防止偽裝和欺騙。

- **防止重放攻擊**:

  IPsec包含重放保護機制，防止數據被攔截後重複發送。

## 2. 為什麼IPsec在IPv6中變得更重要？

在IPv6的標準中，IPsec被視為**一個必須支持的功能**，原因如下:

- **內建安全性**:

  IPv6設計初衷是實現端到端通信，讓每台設備都可以擁有唯一的公有IP。這種直接互聯的架構增加了暴露在公網上的風險，因此IPsec成為IPv6的內建安全防護機制，能夠在數據層提供端到端的加密和保護。

- **全球標準化**:

  IPv4中的IPsec雖然是可選的，但IPv6則內建支持IPsec，並將其標準化，這意味著支持IPv6的設備應該都具備IPsec的能力。

## 3. IPsec的加密過程

**IPsec(Internet Protocol Security)**是一種用於網路層的安全協定，提供數據加密、驗證和完整性保障，主要由以下部分組成:

- **AH(Authentication Header)**:

  AH協定提供數據包的**完整性驗證**和**來源驗證**，但不提供加密。

  這意味著它可以防範數據包被篡改，但無法隱藏數據內容。

- **ESP(Encapsulating Security Payload)**:

  ESP協定是IPsec中最常用的加密協定，提供**數據加密**、**完整性校驗**和**來源驗證**，

  使得數據內容既能加密隱藏，又能防止篡改。

  ESP的具體加密步驟如下:

  1. **數據加密**:

     ESP協定使用對稱加密(例如AES)來加密數據包的內容，只有持有密鑰的接收方才能解密查看數據內容。

  2. **封裝數據包**:

     加密後的數據包再被封裝為ESP封包，並附加一個驗證碼，用於確認數據的完整性。

  3. **來源驗證**:

     接收方在收到ESP數據包後，通過密鑰進行解密，並驗證數據包的來源是否真實，數據內容是否未被篡改。

### IPsec的密鑰交換

IPsec使用**IKE(Internet Key Exchange)**協定來進行密鑰交換和加密參數的協商。

IKE協定確保雙方安全地同意加密協定和密鑰，並建立IPsec隧道。

### IPsec的應用場景

- **VPN(虛擬專用網)**:

  IPsec常用於VPN，通過加密和隧道建立，在公網上提供安全的私密通信。

- **網路層安全**:

  IPsec在網路層加密數據，適合需要在不同網路之間提供整體加密的情況，例如跨網段的公司網路通信。

## 3. IPsec與SSL的區別

### 工作層級的不同

- **IPsec在網路層**:

  IPsec位於OSI模型的第三層(網路層)，直接對數據包加密，這意味著所有流量(包括應用層的所有協定)都會被加密，因此更適合整體網路通信加密。

- **SSL在應用層**:

  SSL(現代版本為TLS)則位於OSI模型的第七層(應用層)，通常用於特定的應用協定(如HTTP、SMTP)之上。

  SSL主要用於加密應用層的數據通信，例如HTTPS協定就是HTTP協定上加了SSL加密的結果。

### 加密範圍與方式的不同

- **IPsec的加密範圍更廣**:

  IPsec加密的是整個IP數據包，因此可以在IP層封裝所有協定的流量，形成一條完整的加密隧道。

- **SSL的加密針對應用層**:

  SSL僅加密應用層數據，通常只針對特定應用(如瀏覽器的HTTPS請求)。它不加密整個數據包，而僅對特定應用層協定的內容加密。

### 使用方式的不同

- **IPsec適合VPN和整體網路安全**:

  IPsec適合需要加密整體網路通信的場景，例如在VPN中提供端到端的加密隧道。

- **SSL適合網頁、郵件等應用安全**:

  SSL更適合保護特定應用，例如網頁的HTTPS加密。SSL/TLS加密僅在應用層生效，無法加密其他層流量。

## 總結

- **IPsec在網路層運行**，加密整個數據包，適合VPN等需要整體加密的場景。

  - **加密位置**:

    在**第三層(網路層)**進行加密。IPsec針對的是整個IP數據包，包括上層的所有數據(第四層到第七層的內容)。

  - **加密內容**:

    IPsec將`完整的IP數據包`(包含第四層的傳輸層協定，如TCP或UDP，及其上層的應用數據)進行加密，無論數據是否已經被應用層(如SSL)加密過，`IPsec都將其再次加密`。

  - **應用場景**:

    IPsec適合需要保護整個通信路徑的情況，例如VPN中構建安全隧道，以保護所有網路層之上的協定流量。

- **SSL/TLS在應用層運行**，僅加密應用層數據(例如HTTP請求的內容)，適合特定應用的加密需求(如HTTPS)。

  - **加密位置**:

    在**第七層(應用層)**進行加密。SSL/TLS僅針對應用層的數據(如HTTP的請求和回應內容)進行加密。

  - **加密內容**:

    SSL/TLS主要加密特定應用的內容(例如HTTP的數據)，
    並不影響整個IP數據包。這樣，即使經過SSL/TLS加密的數據流
    仍然會以明文的IP地址、端口等信息進行傳輸。

  - **應用場景**:

    SSL/TLS適合保護特定的應用層協定，
    例如HTTPS加密網頁通信、SMTP加密電子郵件等。

- **IPsec的應用範圍更廣泛**，能夠在網路層上對所有協定提供加密，而SSL主要針對特定的應用層協定。

因此，IPsec和SSL各有不同的應用場景。

- **IPsec**:

  針對整個數據包進行網路層加密，封裝所有上層數據(包括已加密的SSL數據)。

  IPsec適合網路層的整體加密，例如VPN隧道，

- **SSL**針對應用層數據進行加密，保護應用協定(如HTTP)的內容:

  而SSL更適合應用層的數據保護，例如加密網頁通信。
