# NAT(網路位址轉換) — 公有IP與私有IP的橋樑

內網中的設備需要通過「網路位址轉換」(NAT)機制來使用公有IP 與外部網路通訊。

## 1. NAT 通常由路由器處理，並負責將**私有IP轉換為公有IP**

具體過程如下：當外部(網際網路)發送一個封包到內網中的特定設備時：

1. **外部封包到達路由器的公有IP**：

   - 外部網路上的封包首先到達**路由器**，這個封包的目標IP地址是你的路由器的公有IP(例如`203.0.113.1`)，這是ISP分配的對外IP地址。

   - 對外的這個IP地址就是你的「網路出口」，外界無法直接看到內網的私有IP。

2. **NAT查找轉發規則**：

   - 路由器的 NAT 會檢查這個封包，並查看目標端口

     (例如: HTTP請求的80端口或HTTPS的443端口)來確定該封包的實際去向。

     - 在大多數路由器中，

       NAT支援「端口轉發」(Port Forwarding)，通過這個功能，`可以將路由器的特定**端口**與內網中的某個**私有IP**地址綁定`。

       這樣，當外部的封包進入路由器的這個端口時，路由器就能知道這個封包的實際去向。

   - 如果路由器配置了NAT轉發規則(例如: Port Forwarding)，
     NAT會根據這些規則來判斷應該將這個封包轉發到哪個內網設備的私有IP地址。

3. **將封包轉換為私有IP，並轉發到內網**：

   - NAT 查找到對應的內網私有IP後(例如`192.168.1.10`)，會將封包內的目標地址從公有IP(`203.0.113.1`)替換為該私有IP(`192.168.1.10`)。

   - 然後，路由器將封包發送到內網的目標設備。此時，封包的目標地址已經被替換為內網的私有IP地址。

4. **內網設備接收封包**：

   - 內網中的設備(如`192.168.1.10`)接收到這個封包後，
     根據封包中的端口號來將數據傳遞到對應的應用程式或服務，完成數據的接收。

### 舉例說明

假設有一台設備(例如: 一台伺服器)在內網中運行，IP地址是`192.168.1.10`，並運行了一個網站服務器在 80 port 上：

1. 外部網路上的用戶在瀏覽器中輸入你的公有IP(`203.0.113.1`)，並發出 HTTP 請求到 80 port。

2. 該請求抵達到路由器，NAT 在路由器中查看到這個 80 port 請求，並根據轉發規則，將目標IP地址改為`192.168.1.10`。

3. NAT將封包傳送到內網的`192.168.1.10`的設備上。

4. `192.168.1.10`上的伺服器接收請求並回應數據，然後這個回應會經過NAT，再將源IP地址替換為路由器的公有IP，以便回傳給外部請求方。

### 小結

- **外網進入路由器**:

  封包進入路由器的公有IP。

- **NAT 進行地址轉換**:

  NAT 根據轉發規則將封包內的公有IP和端口轉換為對應的內網私有IP和端口。

- **內網設備接收封包**:

  封包到達內網設備的私有IP，完成數據傳遞。

- **NAT回應轉換**:

  回應時，NAT再將私有IP轉換為公有IP，以便回傳給外部設備。

這樣的流程保證了數據可以正確地從外網傳送到內網中特定的設備，而內網設備也可以隱藏在NAT後方，不直接暴露給外部網路。

## 2. 多個內網服務的情況

如果你在內網中有多台設備，並且希望讓它們提供不同的服務，可以通過不同的端口來區分。

例如:

- 將公有IP的80端口轉發到`192.168.1.10`上的80端口(例如Web伺服器)。

- 將公有IP的8080端口轉發到`192.168.1.20`上的80端口(例如另一台Web伺服器)。

- 將公有IP的22端口轉發到`192.168.1.15`上的22端口(例如SSH服務)。

這樣，你只需要在網址列中輸入**公有IP + 端口號**，

NAT端口轉發規則會將請求定向到正確的內網設備。例如:

- 輸入`203.0.113.1:80`，訪問`192.168.1.10`上的Web服務。

- 輸入`203.0.113.1:8080`，訪問`192.168.1.20`上的另一個Web服務。

### 小結

- **公有IP**:

  當你輸入的是公有IP(如`203.0.113.1`)，外部封包會到達路由器。

- **NAT端口轉發**:

  路由器根據端口轉發規則，將封包轉送至指定的內網設備(特定的私有IP)。

- **端口區分**:

  使用不同的端口轉發，可以將同一個公有IP的不同端口對應到內網中不同的私有IP及服務。

這樣的配置確保了你可以透過公有IP，透過不同端口號，訪問內網中的不同設備或服務。

## 3. 不同 private ip 可以同時綁定 80 port 嗎？

在內網中，

**不同的私有IP設備可以同時綁定相同的端口**(例如80端口)，並不會互相衝突。

這是因為在內網中，IP地址是唯一標識每台設備的基礎，端口的綁定只對該IP地址有效。

### 具體解釋

1. **不同的私有IP地址**:

   內網中的每個設備都有一個獨立的私有IP(如`192.168.1.10`、`192.168.1.20`等)，每個私有IP都是在內網中唯一的。

   這意味著內網中的每台設備都可以綁定相同的端口而互不影響，因為它們的IP不同。

2. **端口綁定在特定的私有IP上**:

   - 假設內網中有兩台設備，它們的IP分別是`192.168.1.10`和`192.168.1.20`，這兩台設備都可以在80端口上運行各自的服務。

   - 對於`192.168.1.10`上的80端口服務，內網中的其他設備可以通過`http://192.168.1.10:80`訪問它。

   - 同樣，對於`192.168.1.20`上的80端口服務，內網中的其他設備可以通過`http://192.168.1.20:80`來訪問它。

3. **外部訪問的端口轉發**：

   - 如果你希望外部網路的使用者訪問這些內網設備，可以通過NAT端口轉發在路由器上設置不同的外部端口，將請求轉發到不同的內網IP。例如：

     - 將**公有IP的80端口**轉發到`192.168.1.10:80`(即內網中的某台Web伺服器)。

     - 將**公有IP的8080端口**轉發到`192.168.1.20:80`(即另一台內網Web伺服器)。

   - 這樣，外部網路中的用戶可以通過`http://公有IP:80`訪問`192.168.1.10`的服務，通過`http://公有IP:8080`訪問`192.168.1.20`的服務。

### 小結

- **不同的私有IP可以同時綁定相同的端口**，例如多台內網設備各自都可以使用自己80端口。

- **端口綁定在特定的IP上**，所以不同私有IP設備的相同端口不會發生衝突。

- 若需外部訪問，則可透過**NAT端口轉發**，使用不同的外部端口來區分不同的內網服務。

- 由此可知，公有IP在對外時，特定的端口(例如80或443)都只能對應到**一個**內網伺服器。

這樣的配置可以充分利用內網的私有IP和端口資源，並在需要時將服務通過端口轉發暴露給外部網路。

## 3. 如何解決多個內網服務的訪問需求

1. **直接透過指定不同公有端口指定到不同的內網ip + port**：

   - 如果內網中有多台設備都需要對外提供HTTP服務，

   可以通過**不同的公有端口映射到不同的私有IP的80端口**。

   例如：

   - 將公有IP的80端口映射到`192.168.1.10:80`，這樣外部用戶可以通過`http://203.0.113.1`訪問`192.168.1.10`的HTTP服務。

   - 將公有IP的8080端口映射到`192.168.1.20:80`，這樣外部用戶可以通過`http://203.0.113.1:8080`訪問`192.168.1.20`的HTTP服務。

   - 這樣的配置方式確保了多台內網設備可以通過不同的外部端口來提供HTTP服務。

2. **使用反向代理伺服器解決多個80端口的需求**：

   - 假設所有設備都要使用80端口進行HTTP訪問，可以考慮在路由器或內網中配置一個**反向代理伺服器 proxy server**(如Nginx或HAProxy)。

   - 直接對接路由器，負責接收來自外部的請求，例如公有IP上的 80端口(HTTP) 和 443端口(HTTPS)。

   - 再根據請求內容或配置規則，將封包轉發到內網的不同伺服器中(Private IP + Port)，例如轉發到 192.168.1.10:80 或 192.168.1.20:443。

   例如: 反向代理監聽在80端口上所有的HTTP請求

   再根據請求的不同路徑或域名，將請求分發到內網的不同設備。

   - 當訪問`http://203.0.113.1/service1`時，反向代理會將請求轉發到`192.168.1.10:80`。

   - 當訪問`http://203.0.113.1/service2`時，反向代理會將請求轉發到`192.168.1.20:80`。

   整體流程如下：

   ```plaintext
   外部用戶 -> 公有IP:80 -> 路由器/NAT 查找轉發規則(查映射表)，將封包的目標IP替換成私有IP ->
   轉發封包到私有IP(192.168.1.10:80)，即反向代理伺服器 -> 反向代理伺服器收到封包 ->
   根據路徑或域名，將封包分發到對應的其他內網設備(如: 192.168.1.20:80) ->
   內網設備回應封包 -> 回應封包經由反向代理伺服器 ->
   路由器/NAT，將封包的目標IP替換成公有IP，並記錄公有IP和私有IP的映射表-> 返回外部用戶
   ```

這種架構能夠集中管理對外的端口映射，並且有效解決單一公有IP無法直接支持多台內網設備對外提供相同端口服務的限制。

### 總結

- **公有IP的80端口**:

  只能映射到一個私有IP的80端口，因此公有IP的80端口僅能提供一個服務。

- 如果內網中有多個80端口服務:

  - 可使用**不同的公有端口映射到不同的私有IP**，例如將8080映射到另一台設備的80端口。

  - **反向代理**:

    負責監聽公有ip 的 80 port，封包統一都先送到 proxy server，

    再由 proxy server 負責將封包轉發到多個內網內不同的設備。

    例如: 根據路徑或域名等方式來轉發封包

這樣的配置方式可以靈活地支持多台內網設備通過公有IP對外提供服務。
