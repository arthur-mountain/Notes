# NAT(網路位址轉換) — 公有IP與私有IP的橋樑

內網中的設備需要通過「網路位址轉換」（NAT）機制來使用公有IP 與外部網路通訊。

## NAT 通常由路由器處理，並負責將**私有IP轉換為公有IP**

具體過程如下：當外部(網際網路)發送一個封包到內網中的特定設備時：

1. **外部封包到達路由器的公有IP**：

   - 外部網路上的封包首先到達**路由器**，這個封包的目標IP地址是你的路由器的公有IP(例如`203.0.113.1`)，這是ISP分配的對外IP地址。

   - 對外的這個IP地址就是你的「網路出口」，外界無法直接看到內網的私有IP。

2. **NAT查找轉發規則**：

   - 路由器的 NAT 會檢查這個封包，並查看目標端口(例如: HTTP請求的80端口或HTTPS的443端口)來確定該封包的實際去向。

   - 如果路由器配置了NAT轉發規則(例如: Port Forwarding)，
     NAT會根據這些規則來判斷應該將這個封包轉發到哪個內網設備的私有IP地址。

3. **將封包轉換為私有IP，並轉發到內網**：

   - NAT 查找到對應的內網私有IP後(例如`192.168.1.10`)，會將封包內的目標地址從公有IP(`203.0.113.1`)替換為該私有IP(`192.168.1.10`)。

   - 然後，路由器將封包發送到內網的目標設備。此時，封包的目標地址已經被替換為內網的私有IP地址。

4. **內網設備接收封包**：

   - 內網中的設備(如`192.168.1.10`)接收到這個封包後，
     根據封包中的端口號來將數據傳遞到對應的應用程式或服務，完成數據的接收。

## 舉例說明

假設有一台設備(例如: 一台伺服器)在內網中運行，IP地址是`192.168.1.10`，並運行了一個網站服務器在 80 port 上：

1. 外部網路上的用戶在瀏覽器中輸入你的公有IP(`203.0.113.1`)，並發出 HTTP 請求到 80 port。

2. 該請求抵達到路由器，NAT 在路由器中查看到這個 80 port 請求，並根據轉發規則，將目標IP地址改為`192.168.1.10`。

3. NAT將封包傳送到內網的`192.168.1.10`的設備上。

4. `192.168.1.10`上的伺服器接收請求並回應數據，然後這個回應會經過NAT，再將源IP地址替換為路由器的公有IP，以便回傳給外部請求方。

## 總結

- **外網進入路由器**:

  封包進入路由器的公有IP。

- **NAT 進行地址轉換**:

  NAT 根據轉發規則將封包內的公有IP和端口轉換為對應的內網私有IP和端口。

- **內網設備接收封包**:

  封包到達內網設備的私有IP，完成數據傳遞。

- **NAT回應轉換**:

  回應時，NAT再將私有IP轉換為公有IP，以便回傳給外部設備。

這樣的流程保證了數據可以正確地從外網傳送到內網中特定的設備，而內網設備也可以隱藏在NAT後方，不直接暴露給外部網路。

